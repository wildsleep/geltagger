/*
	geltagger.js - Automated Gelbooru file tagger
	by Greg Smith

	Version 0.1.0
	Full source at https://github.com/smrq/geltagger
	Copyright (c) 2012 Greg Smith

	MIT License, https://github.com/smrq/geltagger/blob/master/LICENSE.md
	This file is generated by `cake build`, do not edit it by hand.
*/
((function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;s=require("sys"),e=require("fs"),v=require("timers"),o=require("path"),d=require("child_process").exec,b=require("async"),l=require("MD5"),r=require("restler"),A=require("xml2js"),a=require("optimist").usage("Usage: $0 -d [dir] -o [dir] -t [timeout]").options("d",{description:"Select the directory to tag files in",alias:"dir",demand:!0}).options("o",{description:"Select a directory to output tagged files into",alias:"output",demand:!0}).options("t",{demands:"Request interval for the Gelbooru service",alias:"interval","default":1e3}).options("p",{description:"Path to the imagemagick convert tool",alias:"convert-path","default":"convert"}).options("w",{description:"Watches the input directory for files",alias:"watch"}).options("x",{description:"Deletes the original source file after successfully tagging",alias:"delete-source"}).argv,m=function(a,b){var c,d,e,f;b==null&&(b={}),f=Object.keys(b);for(d=0,e=f.length;d<e;d++)c=f[d],a[c]=b[c];return a},q=function(a,b){var c,d,e,f;c=[];for(e=0,f=a.length;e<f;e++)d=a[e],b(d)||c.push(d);return c},w=function(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")},j=a.d,n=a.o,k=a.t,i=a.p,x=a.w,c=a.x,p={e:"explicit",q:"questionable",s:"safe"},f=function(){var a;return a=[],v.setInterval(function(){var b,c,d,e;if(a.length>0)return e=a.shift(),c=e.hash,b=e.callback,d="http://gelbooru.com/index.php?page=dapi&s=post&q=index&tags=md5:"+c,console.log("Requesting md5:"+c),r.get(d).on("complete",function(a){return(new A.Parser).parseString(a,b)})},k),function(b,c){return a.push({hash:b,callback:c})}}(),z=function(a,b,c,f){var g,h,j;return j=""+b+".iptc",e.writeFileSync(j,c),h='"'+i+'" +profile 8BIM -profile 8BIMTEXT:'+j+" "+a+" "+b,g=d(h,function(c,d,g){return d&&console.log("ImageMagick ("+a+"): "+d),g&&console.error("ImageMagick ("+a+"): "+g),c?f(c):(e.unlinkSync(j),console.log("Tagged file written to "+b),f())})},g=function(a,b){var c,d,e,f;c=['8BIM#1028="IPTC"','2#0="&#0;&#2;'],b!=null&&c.push('2#110#Credit="'+b+'"');for(e=0,f=a.length;e<f;e++)d=a[e],c.push('2#25#Keyword="'+d+'"');return c.join("\n")},h=function(a){var b,c,d,e;return a==null?null:a["@"]==null?null:a["@"].count!=="1"?null:(a=(d=a.post["@"])!=null?d:{},c=(e=a.tags)!=null?e:"",c=q(c.split(" "),function(a){return w(a)===""}),a.rating!=null&&c.push("rating:"+p[a.rating]),a.id!=null&&c.push("id:"+a.id),a.source&&(b=a.source),{tags:c,source:b})},u=function(a,b,d,i){var j,k;return j=o.join(b,a),k=o.join(d,a),e.readFile(j,function(a,b){var d;return a!=null?i(a):(d=l(b),f(d,function(a,b){var f,l,m,n;return a!=null?i(a):(l=h(b),l==null?i("Invalid post data for file "+j+" with hash "+d+"\n"+s.inspect(b)):(n=l.tags,m=l.source,f=g(n,m),z(j,k,f,function(a){return c&&a==null&&e.unlinkSync(j),i(a)})))}))})},t=function(a,c,d){return e.readdir(a,function(e,f){var g;return e!=null?d(e):(g=0,b.forEach(f,function(b,d){return console.log("Tagging file: "+b),u(b,a,c,function(a){return a!=null&&(console.error(""+a),g++),d()})},function(a){return a!=null?d(a):g>0?d("Tagging failed on "+g+" files."):d()}))})},y=function(){var a;return a={},function(b,c,d){return e.watch(b,function(e,f){if(f!=null)return a[{inFile:f,inDir:b,outDir:c,cb:d}]=!0,v.setTimeout(function(){if(a[{inFile:f,inDir:b,outDir:c,cb:d}])return delete a[{inFile:f,inDir:b,outDir:c,cb:d}],console.log("Found file: "+f),u(f,b,c,d)},100)})}}(),x?y(j,n,function(a){if(a!=null)return console.error(""+a)}):t(j,n,function(a){return a!=null?(console.error(""+a),process.exit(1)):(console.log("Process completed successfully."),process.exit(0))})})).call(this)