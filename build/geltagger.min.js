/*
	geltagger.js - Automated Gelbooru file tagger
	by Greg Smith

	Version 0.1.0
	Full source at https://github.com/smrq/geltagger
	Copyright (c) 2011 Greg Smith

	MIT License, https://github.com/smrq/geltagger/blob/master/LICENSE.md
	This file is generated by `cake build`, do not edit it by hand.
*/
((function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z;r=require("sys"),d=require("fs"),u=require("timers"),n=require("path"),c=require("child_process").exec,b=require("async"),k=require("MD5"),q=require("restler"),z=require("xml2js"),a=require("optimist").usage("Usage: $0 -d [dir] -o [dir] -t [timeout]").options("d",{description:"Select the directory to tag files in",alias:"dir",demand:!0}).options("o",{description:"Select a directory to output tagged files into",alias:"output",demand:!0}).options("t",{demands:"Request interval for the Gelbooru service",alias:"interval","default":1e3}).options("p",{description:"Path to the imagemagick convert tool",alias:"convert-path","default":"convert"}).options("w",{description:"Watches the input directory for files",alias:"watch"}).argv,l=function(a,b){var c,d,e,f;b==null&&(b={}),f=Object.keys(b);for(d=0,e=f.length;d<e;d++)c=f[d],a[c]=b[c];return a},p=function(a,b){var c,d,e,f;c=[];for(e=0,f=a.length;e<f;e++)d=a[e],b(d)||c.push(d);return c},v=function(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")},i=a.d,m=a.o,j=a.t,h=a.p,w=a.w,o={e:"explicit",q:"questionable",s:"safe"},e=function(){var a;return a=[],u.setInterval(function(){var b,c,d,e;if(a.length>0)return e=a.shift(),c=e.hash,b=e.callback,d="http://gelbooru.com/index.php?page=dapi&s=post&q=index&tags=md5:"+c,console.log("Requesting md5:"+c),q.get(d).on("complete",function(a){return(new z.Parser).parseString(a,b)})},j),function(b,c){return a.push({hash:b,callback:c})}}(),y=function(a,b,e,f){var g,i,j;return j=""+b+".iptc",d.writeFileSync(j,e),i='"'+h+'" +profile 8BIM -profile 8BIMTEXT:'+j+" "+a+" "+b,g=c(i,function(c,e,g){return e&&console.log("ImageMagick ("+a+"): "+e),g&&console.error("ImageMagick ("+a+"): "+g),c?f(c):(d.unlinkSync(j),console.log("Tagged file written to "+b),f())})},f=function(a,b){var c,d,e,f;c=['8BIM#1028="IPTC"','2#0="&#0;&#2;'],b!=null&&c.push('2#110#Credit="'+b+'"');for(e=0,f=a.length;e<f;e++)d=a[e],c.push('2#25#Keyword="'+d+'"');return c.join("\n")},g=function(a){var b,c,d,e;return a==null?null:a["@"]==null?null:a["@"].count!=="1"?null:(a=(d=a.post["@"])!=null?d:{},c=(e=a.tags)!=null?e:"",c=p(c.split(" "),function(a){return v(a)===""}),a.rating!=null&&c.push("rating:"+o[a.rating]),a.id!=null&&c.push("id:"+a.id),a.source&&(b=a.source),{tags:c,source:b})},t=function(a,b,c,h){var i,j;return i=n.join(b,a),j=n.join(c,a),d.readFile(i,function(a,b){var c;return a!=null?h(a):(c=k(b),e(c,function(a,b){var d,e,k,l;return a!=null?h(a):(e=g(b),e==null?h("Invalid post data for file "+i+" with hash "+c+"\n"+r.inspect(b)):(l=e.tags,k=e.source,d=f(l,k),y(i,j,d,h)))}))})},s=function(a,c,e){return d.readdir(a,function(d,f){var g;return d!=null?e(d):(g=null,b.forEach(f,function(b,d){return console.log("Tagging file: "+b),t(b,a,c,d)},e))})},x=function(){var a;return a={},function(b,c,e){return d.watch(b,function(d,f){if(f!=null)return a[{inFile:f,inDir:b,outDir:c,cb:e}]=!0,u.setTimeout(function(){if(a[{inFile:f,inDir:b,outDir:c,cb:e}])return delete a[{inFile:f,inDir:b,outDir:c,cb:e}],console.log("Found file: "+f),t(f,b,c,e)},100)})}}(),w?x(i,m,function(a){if(a!=null)return console.error(""+a)}):s(i,m,function(a){return a!=null?(console.error(""+a),process.exit(1)):(console.log("Process completed successfully."),process.exit(0))})})).call(this)