/*
	geltagger.js - Automated Gelbooru file tagger
	by Greg Smith

	Version 0.1.1
	Full source at https://github.com/smrq/geltagger
	Copyright (c) 2012 Greg Smith

	MIT License, https://github.com/smrq/geltagger/blob/master/LICENSE.md
	This file is generated by `cake build`, do not edit it by hand.
*/
((function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B;t=require("sys"),f=require("fs"),w=require("timers"),p=require("path"),e=require("child_process").exec,b=require("async"),m=require("MD5"),s=require("restler"),B=require("xml2js"),a=require("optimist").usage("Usage: $0 -d [dir] -o [dir] -t [timeout]").options("d",{description:"Select the directory to tag files in",alias:"dir",demand:!0}).options("o",{description:"Select a directory to output tagged files into",alias:"output",demand:!0}).options("t",{demands:"Request interval for the Gelbooru service",alias:"interval","default":1e3}).options("p",{description:"Path to the imagemagick convert tool",alias:"convert-path","default":"convert"}).options("w",{description:"Watches the input directory for files",alias:"watch"}).options("x",{description:"Deletes the original source file after successfully tagging",alias:"delete-source"}).argv,RegExp.quote=function(a){return a.replace(/([.?*+^$[\]\\(){}-])/g,"\\$1")},n=function(a,b){var c,d,e,f;b==null&&(b={}),f=Object.keys(b);for(d=0,e=f.length;d<e;d++)c=f[d],a[c]=b[c];return a},r=function(a,b){var c,d,e,f;c=[];for(e=0,f=a.length;e<f;e++)d=a[e],b(d)||c.push(d);return c},x=function(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")},c=function(a,b){var c;return c=p.extname(a),c===""?a+b:a.replace(new RegExp(RegExp.quote(c)+"$"),b)},k=a.d,o=a.o,l=a.t,j=a.p,y=a.w,d=a.x,q={e:"explicit",q:"questionable",s:"safe"},g=function(){var a;return a=[],w.setInterval(function(){var b,c,d,e;if(a.length>0)return e=a.shift(),c=e.hash,b=e.callback,d="http://gelbooru.com/index.php?page=dapi&s=post&q=index&tags=md5:"+c,console.log("Requesting md5:"+c),s.get(d).on("complete",function(a){return(new B.Parser).parseString(a,b)})},l),function(b,c){return a.push({hash:b,callback:c})}}(),A=function(a,b,c,d){var g,h,i;return i=""+b+".iptc",f.writeFileSync(i,c),h='"'+j+'" +profile 8BIM -profile 8BIMTEXT:'+i+" "+a+" "+b,g=e(h,function(c,e,g){return e&&console.log("ImageMagick ("+a+"): "+e),g&&console.error("ImageMagick ("+a+"): "+g),c?d(c):(f.unlinkSync(i),console.log("Tagged file written to "+b),d())})},h=function(a,b){var c,d,e,f;c=['8BIM#1028="IPTC"','2#0="&#0;&#2;'],b!=null&&c.push('2#110#Credit="'+b+'"');for(e=0,f=a.length;e<f;e++)d=a[e],c.push('2#25#Keyword="'+d+'"');return c.join("\n")},i=function(a){var b,c,d,e;return a==null?null:a["@"]==null?null:a["@"].count!=="1"?null:(a=(d=a.post["@"])!=null?d:{},c=(e=a.tags)!=null?e:"",c=r(c.split(" "),function(a){return x(a)===""}),a.rating!=null&&c.push("rating:"+q[a.rating]),a.id!=null&&c.push("id:"+a.id),a.source&&(b=a.source),{tags:c,source:b})},v=function(a,b,e,j){var k,l;return k=p.join(b,a),l=p.join(e,c(a,".jpg")),f.readFile(k,function(a,b){var c;return a!=null?j(a):(c=m(b),g(c,function(a,b){var e,g,m,n;return a!=null?j(a):(g=i(b),g==null?j("Invalid post data for file "+k+" with hash "+c+"\n"+t.inspect(b)):(n=g.tags,m=g.source,e=h(n,m),A(k,l,e,function(a){return d&&a==null&&f.unlinkSync(k),j(a)})))}))})},u=function(a,c,d){return f.readdir(a,function(e,f){var g;return e!=null?d(e):(g=0,b.forEach(f,function(b,d){return console.log("Tagging file: "+b),v(b,a,c,function(a){return a!=null&&(console.error(""+a),g++),d()})},function(a){return a!=null?d(a):g>0?d("Tagging failed on "+g+" files."):d()}))})},z=function(){var a;return a={},function(b,c,d){return f.watch(b,function(e,f){if(f!=null)return a[{inFile:f,inDir:b,outDir:c,cb:d}]=!0,w.setTimeout(function(){if(a[{inFile:f,inDir:b,outDir:c,cb:d}])return delete a[{inFile:f,inDir:b,outDir:c,cb:d}],console.log("Found file: "+f),v(f,b,c,d)},100)})}}(),y?z(k,o,function(a){if(a!=null)return console.error(""+a)}):u(k,o,function(a){return a!=null?(console.error(""+a),process.exit(1)):(console.log("Process completed successfully."),process.exit(0))})})).call(this)